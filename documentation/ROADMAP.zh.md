# 📍 ROADMAP - 民主链RAG系统

## 🧠 RAG 的最终目标

**输入：** 选民用自然语言表达的偏好 **输出：**
与该偏好最匹配的 10 份竞选纲领

## 🗺️ 实现 RAG 的详细路线图

### 🔹 阶段 1：批量文档摄取

| 步骤    | 描述                                                                             | 工具                                                                                |
| ------- | -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| **1.1** | 标准化输入格式（PDF、Word、txt 等）                                              | `unstructured`、`pdfminer`、`docx`                                                  |
| **1.2** | 将文本分块（带元数据的智能切片）                                                 | `langchain.text_splitter.RecursiveCharacterTextSplitter` 或 `unstructured.chunking` |
| **1.3** | 使用元数据保存文档（例如 `candidato`、`partido`、`año` 等）                      | 使用带结构化 payload 的 Qdrant（如 `source_id`、`title`、`page`、`party` 等）       |
| **1.4** | 实现文档处理 worker（监听 RabbitMQ/Kafka，并执行 parse → chunk → embed → index） | RabbitMQ（轻量，基础设施中已有）、Qdrant、FastAPI Worker                            |

📁 **结果**：所有程序被处理、嵌入并带元数据地存储在 Qdrant 中。

### 🔹 阶段 2：生成与检索嵌入向量

| 步骤    | 描述                                                                           | 工具                                                                                             |
| ------- | ------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| **2.1** | 选择本地嵌入模型（轻量、精确、支持多语言）                                     | `BAAI/bge-small-en-v1.5` 或 `intfloat/multilingual-e5-small` 与 `sentence-transformers` 搭配使用 |
| **2.2** | 提供 API `/search?q=...`：1️⃣ 生成查询嵌入，2️⃣ 查询 Qdrant，3️⃣ 返回文本与元数据 | FastAPI + `qdrant-client`                                                                        |
| **2.3** | 添加可选搜索过滤器（如 `partido`、`año`、`candidato` 等）                      | Qdrant 支持 payload 上的布尔过滤                                                                 |
| **2.4** | 最终排序：可选使用 `bge-reranker` 进行语义重排序或结合时间权重                 | `bge-reranker-base`（如需本地语义 reranking）                                                    |

📁 **结果**：一个强大、精准、可定制的语义搜索端点。

### 🔹 阶段 3：前端（搜索 + 结果展示）

| 步骤    | 描述                                 | 工具                                                         |
| ------- | ------------------------------------ | ------------------------------------------------------------ |
| **3.1** | 实现带候选人/政党过滤器的搜索表单    | React + Tailwind + Zustand（若使用全局状态管理）             |
| **3.2** | 结果展示：突出关键词片段并显示元数据 | 使用 `<mark>` 高亮匹配词，如 `...文本<mark>关键词</mark>...` |
| **3.3** | 添加分页或无限滚动（若结果较多）     | `react-infinite-scroll-component`                            |

📁 **结果**：一个现代、清晰的用户界面供选民搜索使用。

### 🔹 阶段 4：可扩展性与鲁棒性

| 步骤    | 描述                                                                  | 工具                                                      |
| ------- | --------------------------------------------------------------------- | --------------------------------------------------------- |
| **4.1** | 多 worker 并行索引（使用 RabbitMQ 队列 + 确认/重试机制）              | RabbitMQ durable queues                                   |
| **4.2** | 使用 Redis 缓存常见查询（例如搜索字符串 → top10 id，设置 6 小时过期） | Redis                                                     |
| **4.3** | Qdrant 分片（按地区、选举类型等）或多实例部署                         | Qdrant 集群模式（v1.7+）或协调多个实例                    |
| **4.4** | 日志、指标、错误 → Prometheus + Grafana                               | `prometheus_fastapi_instrumentator` + Docker 化的 Grafana |

📁 **结果**：一个可横向扩展、具备错误处理机制的健壮系统。

### 🔹 阶段 5：评估与反馈

| 步骤    | 描述                                              | 工具                                                  |
| ------- | ------------------------------------------------- | ----------------------------------------------------- |
| **5.1** | 创建测试数据集：模拟选民查询 + 预期相关程序       | CSV：包含 `query,texto_relevante_expected`            |
| **5.2** | 衡量 top-k 精度（例如：目标程序是否出现在 top10） | 使用 recall/precision/accuracy 指标的验证脚本         |
| **5.3** | 收集用户反馈：对结果添加 👍👎 按钮并记录反馈      | PostgreSQL 记录 `query`、`result_id`、`feedback=1/-1` |

📁 **结果**：系统具备评估机制，可基于反馈不断优化。

## 🧰 本地 + 免费的基础需求

- 🔎 **Qdrant** 本地部署（Docker 模式）→ 支持高级过滤的向量存储
- 🧠
  **本地嵌入模型**（如 BGE-small、E5-small）→ 内存约 300–400MB，CPU 即可运行
- 🐇 **RabbitMQ** → 已在 `docker-compose.yml` 中配置
- 🐍 **FastAPI** → 用于搜索与摄取的 REST API
- 🐳 **Docker Compose** → 一键部署所有组件

## 🚀 推荐的下一步？

> 实现一个**独立脚本** `processor.py`：
>
> 1. 遍历 `./programs/*.pdf`
> 2. 按页提取文本
> 3. 拆分为带元数据的 chunks
> 4. 生成嵌入向量
> 5. 插入 Qdrant
>
> 这将构建系统的核心基础，而无需立即集成完整后端。
